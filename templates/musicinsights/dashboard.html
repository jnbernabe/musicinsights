{% extends "base.html" %} {% block content %}

<!-- Header -->
<div class="dashboard-header">
  <div class="header-title">
    <h2>{{ playlist_name }}</h2>
    <p>Dashboard Overview</p>
  </div>
  <a href="{% url 'upload_file' %}" class="btn"
    ><i class="ph ph-upload-simple"></i> Upload New CSV</a
  >
</div>

<!-- Bento Grid -->
<div class="bento-grid">
  <!-- Hero Stats -->
  <div class="bento-card col-span-1">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-music-notes card-icon"></i> Playlist Stats</span
      >
    </div>
    <div class="stat-value">{{ total_tracks }}</div>
    <div class="stat-sub">Total songs in playlist</div>

    <div class="stat-value">{{ total_listening_hours }}</div>
    <div class="stat-sub">Hours of listening time</div>
  </div>

  <div class="bento-card col-span-3">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-sparkle card-icon"></i> Insights</span
      >
    </div>
    <ul
      style="
        list-style: none;
        padding: 0;
        margin: 0;
        color: var(--text-secondary);
        font-size: 1.3rem;
      "
    >
      {% for rec in recommendations %}
      <li
        style="margin-bottom: 8px; display: flex; align-items: center; gap: 8px"
      >
        <i class="ph ph-check-circle" style="color: var(--accent-primary)"></i>
        {{ rec }}
      </li>
      {% empty %}
      <li>No insights available yet.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Mood Map (Scatter) -->
  <div class="bento-card col-span-4 row-span-2">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-smiley card-icon"></i> Mood Map</span
      >
    </div>
    <div id="moodChart" class="chart-container"></div>
  </div>

  <!-- Top Artists by Duration (Bar) -->
  <div class="bento-card col-span-2 row-span-2">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-clock card-icon"></i> Top Artists by Duration</span
      >
    </div>
    <div id="artistDurationChart" class="chart-container"></div>
  </div>

  <!-- Audio Features (Radar) -->
  <div class="bento-card col-span-2 row-span-2">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-faders card-icon"></i> Audio Profile</span
      >
    </div>
    <div id="featuresChart" class="chart-container"></div>
  </div>

  <!-- Top Genres (Sunburst) -->
  <div class="bento-card col-span-1 row-span-2">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-chart-pie-slice card-icon"></i> Genres</span
      >
    </div>
    <div id="genreChart" class="chart-container"></div>
  </div>

  <!-- Era Distribution -->
  <div class="bento-card col-span-1 row-span-2">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-hourglass card-icon"></i> Eras</span
      >
    </div>
    <div id="eraChart" class="chart-container"></div>
  </div>

  <!-- Popularity -->
  <div class="bento-card col-span-1 row-span-2">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-trend-up card-icon"></i> Popularity</span
      >
    </div>
    <div id="popularityChart" class="chart-container"></div>
  </div>

  <!-- Tempo -->
  <div class="bento-card col-span-1 row-span-2">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-metronome card-icon"></i> Tempo</span
      >
    </div>
    <div id="tempoChart" class="chart-container"></div>
  </div>

  <!-- Top Artists Table -->
  <div class="bento-card col-span-2">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-users card-icon"></i> Top Artists</span
      >
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Artist</th>
            <th>Tracks</th>
          </tr>
        </thead>
        <tbody>
          {% for name, count in top_artists %}
          <tr>
            <td style="font-weight: 500">{{ name }}</td>
            <td>{{ count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Top Tracks Table -->
  <div class="bento-card col-span-2">
    <div class="card-header">
      <span class="card-title"
        ><i class="ph ph-playlist card-icon"></i> Top Tracks</span
      >
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>Track</th>
            <th>Artist</th>
            <th>Hours</th>
          </tr>
        </thead>
        <tbody>
          {% for t in top_tracks %}
          <tr>
            <td style="font-weight: 500">{{ t.name }}</td>
            <td>{{ t.artist }}</td>
            <td>{{ t.listening_time_hours }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script type="text/javascript">
  // Initialize ECharts Theme
  const theme = null;
  const bgColor = 'transparent';
  const accentColor = '#1DB954';
  const textColor = '#e0e0e0'; // Brighter text
  const axisLineColor = '#444';

  const commonTextStyle = {
      fontFamily: 'Inter, sans-serif',
      fontSize: 14,
      color: textColor
  };

  const axisLabelStyle = {
      color: textColor,
      fontSize: 13,
      fontFamily: 'Inter, sans-serif'
  };

  const titleStyle = {
      color: textColor,
      fontSize: 16,
      fontWeight: 600,
      fontFamily: 'Inter, sans-serif'
  };

  // --- Color Palette ---
  const colorPalette = [
    '#D32F2F', '#00897B', '#FBC02D', '#1B5E20', '#455A64',
    '#7B1FA2', '#0288D1', '#E64A19', '#512DA8', '#C2185B',
    '#388E3C', '#F57F17', '#0277BD', '#BF360C', '#6A1B9A',
    '#689F38', '#AD1457', '#00695C', '#FF8F00', '#4A148C',
    '#004D40', '#D84315', '#006064', '#880E4F', '#33691E'
  ];

  // Helper to init chart
  function initChart(id) {
    const dom = document.getElementById(id);
    if (!dom) return null;
    const chart = echarts.init(dom, theme, { renderer: 'canvas' });
    window.addEventListener('resize', () => chart.resize());
    return chart;
  }

  // Helper for No Data
  function getNoDataOption() {
    return {
      title: {
        text: 'No Data Available',
        left: 'center',
        top: 'center',
        textStyle: { color: '#888', fontSize: 16, fontWeight: 'normal' }
      }
    };
  }

  // --- Mood Map (Scatter) ---
  const moodChart = initChart('moodChart');
  const moodData = {{ mood_data| safe }};
  if (!moodData || moodData.length === 0) {
    if (moodChart) moodChart.setOption(getNoDataOption());
  } else {
    if (moodChart) {
      moodChart.setOption({
        backgroundColor: bgColor,
        tooltip: {
          trigger: 'item',
          formatter: function (params) {
            return `<b>${params.data.name}</b><br/>${params.data.artist}<br/>Valence: ${params.data.value[0]}<br/>Energy: ${params.data.value[1]}`;
          },
          backgroundColor: 'rgba(20, 20, 20, 0.9)',
          borderColor: '#333',
          textStyle: { color: '#fff' }
        },
        grid: { top: 40, right: 30, bottom: 40, left: 50, containLabel: true },
        xAxis: {
          name: 'Valence (Happy)',
          nameLocation: 'middle',
          nameGap: 30,
          nameTextStyle: { color: textColor, fontSize: 14 },
          splitLine: { lineStyle: { color: '#333' } },
          axisLabel: axisLabelStyle
        },
        yAxis: {
          name: 'Energy',
          nameLocation: 'middle',
          nameGap: 40,
          nameTextStyle: { color: textColor, fontSize: 14 },
          splitLine: { lineStyle: { color: '#333' } },
          axisLabel: axisLabelStyle
        },
        series: [{
          symbolSize: 8,
          data: moodData.map((item, index) => ({
            value: [item.x, item.y],
            name: item.name,
            artist: item.artist,
            itemStyle: {
              color: colorPalette[index % colorPalette.length],
              shadowBlur: 10,
              shadowColor: colorPalette[index % colorPalette.length]
            }
          })),
          type: 'scatter'
        }]
      });
    }
  }

  // --- Top Genres (Sunburst) ---
  const genreChart = initChart('genreChart');
  const rawGenreData = {{ top_genres| safe }};
  if (!rawGenreData || rawGenreData.length === 0) {
    if (genreChart) genreChart.setOption(getNoDataOption());
  } else {
    const genreData = rawGenreData.map(g => ({ name: g[0], value: g[1] }));
    if (genreChart) {
      genreChart.setOption({
        backgroundColor: bgColor,
        tooltip: { trigger: 'item' },
        series: {
          type: 'sunburst',
          data: genreData,
          radius: [0, '90%'],
          label: { rotate: 'radial', color: '#fff', fontSize: 12, fontWeight: 'bold' },
          itemStyle: {
            borderRadius: 4,
            borderWidth: 1,
            borderColor: '#111'
          },
          color: colorPalette
        }
      });
    }
  }

  // --- Top Artists by Duration (Bar) ---
  const artistDurationChart = initChart('artistDurationChart');
  const artistDurationLabels = {{ top_artists_duration_labels| safe }};
  const artistDurationValues = {{ top_artists_duration_values| safe }};
  if (!artistDurationLabels || artistDurationLabels.length === 0) {
    if (artistDurationChart) artistDurationChart.setOption(getNoDataOption());
  } else {
    if (artistDurationChart) {
      artistDurationChart.setOption({
        backgroundColor: bgColor,
        tooltip: { trigger: 'axis' },
        grid: { top: 20, right: 30, bottom: 20, left: 120, containLabel: true },
        xAxis: {
          type: 'value',
          splitLine: { lineStyle: { color: '#333' } },
          axisLabel: axisLabelStyle
        },
        yAxis: {
          type: 'category',
          data: artistDurationLabels.reverse(),
          axisLine: { lineStyle: { color: '#444' } },
          axisLabel: {
            color: textColor,
            fontSize: 13,
            fontFamily: 'Inter, sans-serif',
            interval: 0,
            width: 110,
            overflow: 'truncate'
          }
        },
        series: [{
          data: artistDurationValues.reverse(),
          type: 'bar',
          itemStyle: {
            color: new echarts.graphic.LinearGradient(1, 0, 0, 0, [
              { offset: 0, color: '#1DB954' },
              { offset: 1, color: 'rgba(29, 185, 84, 0.1)' }
            ]),
            borderRadius: [0, 4, 4, 0]
          }
        }]
      });
    }
  }

  // --- Audio Features (Radar) ---
  const featuresChart = initChart('featuresChart');
  const featureLabels = {{ feature_labels| safe }};
  const avgFeatures = {{ avg_features| safe }};
  // Check if all features are 0 or empty
  if (!avgFeatures || avgFeatures.length === 0 || avgFeatures.every(v => v === 0)) {
    if (featuresChart) featuresChart.setOption(getNoDataOption());
  } else {
    if (featuresChart) {
      featuresChart.setOption({
        backgroundColor: bgColor,
        tooltip: {},
        radar: {
          center: ['50%', '50%'],
          radius: '65%',
          indicator: featureLabels.map((f, i) => ({
            name: f,
            max: 1,
            color: colorPalette[i % colorPalette.length]
          })),
          splitArea: { areaStyle: { color: ['transparent'] } },
          splitLine: { lineStyle: { color: '#333' } },
          axisLine: { lineStyle: { color: '#333' } },
          axisName: { fontSize: 13 }
        },
        polar: {
          center: ['50%', '50%'],
          radius: '65%'
        },
        angleAxis: {
          type: 'category',
          data: featureLabels,
          boundaryGap: false,
          splitLine: { show: false },
          axisLine: { show: false },
          axisLabel: { show: false },
          startAngle: 90,
          clockwise: false
        },
        radiusAxis: {
          min: 0,
          max: 1,
          axisLine: { show: false },
          axisLabel: { show: false },
          splitLine: { show: false }
        },
        series: [{
          type: 'radar',
          symbolSize: 0,
          data: [{
            value: avgFeatures,
            name: 'Average Profile',
            areaStyle: { color: colorPalette[1] + '4D' },
            lineStyle: { color: colorPalette[1] },
            itemStyle: { color: colorPalette[1] }
          }]
        }, {
          type: 'scatter',
          coordinateSystem: 'polar',
          symbolSize: 8,
          data: avgFeatures.map((val, i) => ({
            value: [val, i],
            itemStyle: {
              color: colorPalette[i % colorPalette.length],
              borderColor: '#fff',
              borderWidth: 1
            }
          })),
          z: 10
        }]
      });
    }
  }

  // --- Time of Day (Pie/Nightingale) ---
  const timeChart = initChart('timeChart');
  const timeLabels = {{ time_of_day_labels| safe }};
  const timeValues = {{ time_of_day_values| safe }};

  if (!timeValues || timeValues.every(v => v === 0)) {
    if (timeChart) timeChart.setOption(getNoDataOption());
  } else {
    // Combine labels and values
    const data = timeLabels.map((label, index) => ({
      name: label,
      value: timeValues[index]
    }));

    if (timeChart) {
      timeChart.setOption({
        backgroundColor: bgColor,
        tooltip: { trigger: 'item' },
        series: [{
          type: 'pie',
          radius: [20, 80],
          roseType: 'area',
          itemStyle: { borderRadius: 5 },
          data: data.map(item => {
            let color = '#A8E6CF';
            if (item.name === 'Morning') color = '#FFE66D';
            if (item.name === 'Afternoon') color = '#4ECDC4';
            if (item.name === 'Evening') color = '#FF6B6B';
            return { ...item, itemStyle: { color: color } };
          })
        }]
      });
    }
  }

  // --- Eras (Bar) ---
  const eraChart = initChart('eraChart');
  const eraLabels = {{ era_labels| safe }};
  const eraValues = {{ era_values| safe }};
  if (!eraLabels || eraLabels.length === 0) {
    if (eraChart) eraChart.setOption(getNoDataOption());
  } else {
    if (eraChart) {
      eraChart.setOption({
        backgroundColor: bgColor,
        tooltip: { trigger: 'axis' },
        grid: { top: 10, right: 10, bottom: 30, left: 10, containLabel: true },
        xAxis: { type: 'category', data: eraLabels, axisLabel: axisLabelStyle },
        yAxis: { type: 'value', show: false },
        series: [{
          data: eraValues.map((val, idx) => ({
            value: val,
            itemStyle: { color: colorPalette[idx % colorPalette.length], borderRadius: 4 }
          })),
          type: 'bar'
        }]
      });
    }
  }

  // --- Popularity (Donut) ---
  const popularityChart = initChart('popularityChart');
  const popLabels = {{ popularity_labels| safe }};
  const popValues = {{ popularity_values| safe }};
  if (!popLabels || popLabels.length === 0) {
    if (popularityChart) popularityChart.setOption(getNoDataOption());
  } else {
    const popData = popLabels.map((label, i) => ({ name: label, value: popValues[i] }));
    if (popularityChart) {
      popularityChart.setOption({
        backgroundColor: bgColor,
        tooltip: { trigger: 'item' },
        legend: { bottom: 0, textStyle: { color: textColor } },
        series: [{
          name: 'Popularity',
          type: 'pie',
          radius: ['40%', '70%'],
          avoidLabelOverlap: false,
          itemStyle: {
            borderRadius: 10,
            borderColor: bgColor,
            borderWidth: 2
          },
          label: { show: false, position: 'center' },
          emphasis: {
            label: { show: true, fontSize: 20, fontWeight: 'bold', color: '#fff' }
          },
          labelLine: { show: false },
          data: popData,
          color: colorPalette
        }]
      });
    }
  }

  // --- Tempo (Line) ---
  const tempoChart = initChart('tempoChart');
  const tempoLabels = {{ tempo_labels| safe }};
  const tempoValues = {{ tempo_values| safe }};
  if (!tempoLabels || tempoLabels.length === 0) {
    if (tempoChart) tempoChart.setOption(getNoDataOption());
  } else {
    if (tempoChart) {
      tempoChart.setOption({
        backgroundColor: bgColor,
        tooltip: { trigger: 'axis' },
        grid: { top: 20, right: 20, bottom: 30, left: 40, containLabel: true },
        xAxis: { type: 'category', data: tempoLabels, axisLabel: axisLabelStyle, boundaryGap: false },
        yAxis: { type: 'value', splitLine: { lineStyle: { color: '#333' } }, axisLabel: axisLabelStyle },
        series: [{
          data: tempoValues,
          type: 'line',
          smooth: true,
          lineStyle: { width: 3, color: colorPalette[3] },
          itemStyle: { color: colorPalette[3] },
          symbolSize: 8
        }]
      });
    }
  }
</script>
{% endblock %}
